<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speech to Text</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4285f4;
            --secondary-color: #34a853;
            --error-color: #ea4335;
            --success-color: #34a853;
            --surface-color: #ffffff;
            --text-primary: #202124;
            --text-secondary: #5f6368;
            --border-color: #dadce0;
            --accent-color: #fbbc05;
            --surface-hover: #f5f5f5;
        }

        body.dark-theme {
            --primary-color: #8ab4f8;
            --secondary-color: #81c995;
            --error-color: #f28b82;
            --success-color: #81c995;
            --surface-color: #202124;
            --text-primary: #e8eaed;
            --text-secondary: #9aa0a6;
            --border-color: #3c4043;
            --accent-color: #fdd663;
            --surface-hover: #303134;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        body {
            background-color: var(--surface-color);
            color: var(--text-primary);
            padding: 0;
            margin: 0;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            padding: 20px;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        h2 {
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .controls-section {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }

        .control-group {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--surface-color);
            color: var(--text-primary);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            padding-right: 30px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--text-secondary);
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            margin-top: 23px;
        }

        .checkbox-label {
            margin-right: 10px;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .transcript-area {
            flex: 1;
            position: relative;
            margin-bottom: 15px;
            min-height: 180px;
            display: flex;
            flex-direction: column;
        }

        textarea {
            width: 100%;
            height: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--surface-color);
            color: var(--text-primary);
            resize: none;
            font-size: 1rem;
            flex: 1;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
        }

        .visualizer {
            margin: 10px 0;
            height: 60px;
            background-color: rgba(0, 0, 0, 0.03);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .wave {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(to bottom, transparent, var(--primary-color, #4285f4) 100%);
            opacity: 0.5;
            transform: translateY(60px);
            transition: transform 0.2s ease;
        }

        .recording .wave {
            transform: translateY(0);
            animation: wave 2s ease infinite;
        }

        @keyframes wave {
            0%, 100% {
                clip-path: polygon(
                    0% 50%, 5% 45%, 10% 55%, 15% 40%, 20% 60%, 25% 35%, 30% 65%, 
                    35% 30%, 40% 50%, 45% 45%, 50% 50%, 55% 45%, 60% 50%, 
                    65% 70%, 70% 35%, 75% 50%, 80% 60%, 85% 45%, 90% 40%, 
                    95% 55%, 100% 50%, 100% 100%, 0% 100%
                );
            }
            50% {
                clip-path: polygon(
                    0% 60%, 5% 35%, 10% 45%, 15% 60%, 20% 40%, 25% 55%, 30% 35%, 
                    35% 60%, 40% 35%, 45% 55%, 50% 45%, 55% 55%, 60% 45%, 
                    65% 50%, 70% 55%, 75% 40%, 80% 40%, 85% 55%, 90% 60%, 
                    95% 45%, 100% 60%, 100% 100%, 0% 100%
                );
            }
        }

        .status-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--text-secondary);
        }

        .status-indicator.recording {
            background-color: var(--error-color);
            box-shadow: 0 0 0 rgba(234, 67, 53, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(234, 67, 53, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(234, 67, 53, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(234, 67, 53, 0);
            }
        }

        .button-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        button {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background-color 0.2s, transform 0.1s;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        button:active:not(:disabled) {
            transform: scale(0.98);
        }

        button i {
            font-size: 1rem;
        }

        .record-btn {
            background-color: var(--primary-color);
            color: white;
        }

        .record-btn.stop {
            background-color: var(--error-color);
        }

        .clear-btn {
            background-color: var(--text-secondary);
            color: white;
        }

        .copy-btn {
            background-color: var(--secondary-color);
            color: white;
        }

        .save-btn {
            background-color: var(--accent-color);
            color: var(--text-primary);
        }

        .status {
            margin-top: 5px;
            text-align: center;
            min-height: 24px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            padding: 5px;
            border-radius: 4px;
            background-color: rgba(0,0,0,0.03);
        }

        .keyboard-shortcuts {
            margin-top: 15px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .keyboard-shortcuts kbd {
            background-color: var(--surface-hover);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 2px 5px;
            display: inline-block;
            margin: 0 3px;
        }

        .language-select-container {
            position: relative;
        }

        .language-select-container::after {
            content: '';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid var(--text-secondary);
            pointer-events: none;
        }

        @media (prefers-color-scheme: dark) {
            body:not(.light-theme) {
                --primary-color: #8ab4f8;
                --secondary-color: #81c995;
                --error-color: #f28b82;
                --success-color: #81c995;
                --surface-color: #202124;
                --text-primary: #e8eaed;
                --text-secondary: #9aa0a6;
                --border-color: #3c4043;
                --accent-color: #fdd663;
                --surface-hover: #303134;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Speech to Text</h2>
        
        <div class="controls-section">
            <div class="control-group">
                <label for="language">Language:</label>
                <select id="language">
                    <option value="en-US">English (US)</option>
                    <option value="en-GB">English (UK)</option>
                    <option value="en-AU">English (Australia)</option>
                    <option value="en-IN">English (India)</option>
                    <option value="hi-IN">Hindi</option>
                    <option value="fr-FR">French</option>
                    <option value="de-DE">German</option>
                    <option value="es-ES">Spanish</option>
                    <option value="it-IT">Italian</option>
                    <option value="ja-JP">Japanese</option>
                    <option value="ko-KR">Korean</option>
                    <option value="pt-BR">Portuguese (Brazil)</option>
                    <option value="ru-RU">Russian</option>
                    <option value="zh-CN">Chinese (Simplified)</option>
                    <option value="zh-TW">Chinese (Traditional)</option>
                    <option value="ar-SA">Arabic</option>
                </select>
            </div>
            <div class="control-group">
                <div class="checkbox-container">
                    <span class="checkbox-label">Show interim results:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="interim-results" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
        
        <div class="transcript-area">
            <textarea id="transcript" placeholder="Transcript will appear here..."></textarea>
            <div class="status-indicator" id="status-indicator"></div>
        </div>
        
        <div class="visualizer">
            <div class="wave" id="wave"></div>
        </div>
        
        <div class="button-container">
            <button id="record-btn" class="record-btn">
                <i class="fas fa-microphone"></i> Start Recording
            </button>
            <button id="clear-btn" class="clear-btn">
                <i class="fas fa-trash"></i> Clear
            </button>
            <button id="copy-btn" class="copy-btn">
                <i class="fas fa-copy"></i> Copy
            </button>
            <button id="save-btn" class="save-btn">
                <i class="fas fa-download"></i> Save
            </button>
        </div>
        
        <div id="status-message" class="status">
            Ready to record
        </div>
        
        <div class="keyboard-shortcuts">
            Press <kbd>Space</kbd> to start/stop recording • <kbd>Ctrl</kbd>+<kbd>C</kbd> to copy • <kbd>Ctrl</kbd>+<kbd>X</kbd> to clear
        </div>
    </div>

    <script>
        // DOM Elements
        const languageSelect = document.getElementById('language');
        const interimResultsCheckbox = document.getElementById('interim-results');
        const transcriptTextarea = document.getElementById('transcript');
        const recordBtn = document.getElementById('record-btn');
        const clearBtn = document.getElementById('clear-btn');
        const copyBtn = document.getElementById('copy-btn');
        const saveBtn = document.getElementById('save-btn');
        const statusMessage = document.getElementById('status-message');
        const statusIndicator = document.getElementById('status-indicator');
        const waveElement = document.getElementById('wave');
        
        // Speech Recognition variables
        let recognition = null;
        let isRecording = false;
        let finalTranscript = '';
        let interimTranscript = '';
        
        // Check if speech recognition is supported
        function initSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                statusMessage.textContent = 'Speech recognition not supported in this browser';
                statusMessage.style.color = 'var(--error-color)';
                recordBtn.disabled = true;
                return false;
            }
            
            recognition = new SpeechRecognition();
            setupRecognition();
            return true;
        }
        
        // Setup speech recognition
        function setupRecognition() {
            recognition.continuous = true;
            recognition.interimResults = interimResultsCheckbox.checked;
            recognition.lang = languageSelect.value;
            
            recognition.onstart = function() {
                isRecording = true;
                updateUI();
                console.log('Speech recognition started');
            };
            
            recognition.onresult = function(event) {
                interimTranscript = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const transcript = event.results[i][0].transcript;
                    
                    if (event.results[i].isFinal) {
                        finalTranscript += transcript + ' ';
                    } else {
                        interimTranscript += transcript;
                    }
                }
                
                updateTranscript();
            };
            
            recognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                
                let errorMessage = 'Error: ';
                switch(event.error) {
                    case 'network':
                        errorMessage += 'Network error. Check your internet connection.';
                        break;
                    case 'not-allowed':
                    case 'service-not-allowed':
                        errorMessage += 'Microphone access denied. Please allow microphone access.';
                        break;
                    case 'aborted':
                        errorMessage += 'Recognition aborted.';
                        break;
                    case 'audio-capture':
                        errorMessage += 'No microphone detected.';
                        break;
                    case 'no-speech':
                        errorMessage += 'No speech detected. Try speaking louder.';
                        break;
                    default:
                        errorMessage += event.error;
                }
                
                statusMessage.textContent = errorMessage;
                statusMessage.style.color = 'var(--error-color)';
                
                // If not a no-speech error, stop recording
                if (event.error !== 'no-speech') {
                    stopRecording();
                }
            };
            
            recognition.onend = function() {
                console.log('Speech recognition ended');
                
                // If still flagged as recording, restart recognition (for continuous mode)
                if (isRecording) {
                    try {
                        recognition.start();
                        console.log('Restarted speech recognition');
                    } catch (error) {
                        console.error('Error restarting recognition:', error);
                        isRecording = false;
                        updateUI();
                    }
                }
            };
        }
        
        // Update the transcript in the textarea
        function updateTranscript() {
            transcriptTextarea.value = finalTranscript + interimTranscript;
            transcriptTextarea.scrollTop = transcriptTextarea.scrollHeight;
        }
        
        // Start recording
        function startRecording() {
            if (!recognition) {
                if (!initSpeechRecognition()) return;
            }
            
            try {
                recognition.start();
                isRecording = true;
                updateUI();
                statusMessage.textContent = 'Listening...';
                statusMessage.style.color = 'var(--success-color)';
            } catch (error) {
                console.error('Error starting recognition:', error);
                statusMessage.textContent = `Error starting recognition: ${error.message}`;
                statusMessage.style.color = 'var(--error-color)';
            }
        }
        
        // Stop recording
        function stopRecording() {
            if (recognition) {
                try {
                    recognition.stop();
                    console.log('Stopped recognition');
                } catch (error) {
                    console.error('Error stopping recognition:', error);
                }
            }
            
            isRecording = false;
            updateUI();
            statusMessage.textContent = 'Recording stopped';
            statusMessage.style.color = 'var(--text-secondary)';
        }
        
        // Toggle recording state
        function toggleRecording() {
            if (isRecording) {
                stopRecording();
            } else {
                startRecording();
            }
        }
        
        // Clear transcript
        function clearTranscript() {
            finalTranscript = '';
            interimTranscript = '';
            transcriptTextarea.value = '';
            statusMessage.textContent = 'Transcript cleared';
            statusMessage.style.color = 'var(--text-secondary)';
        }
        
        // Copy transcript to clipboard
        function copyTranscript() {
            const text = transcriptTextarea.value.trim();
            
            if (!text) {
                statusMessage.textContent = 'Nothing to copy';
                statusMessage.style.color = 'var(--text-secondary)';
                return;
            }
            
            navigator.clipboard.writeText(text)
                .then(() => {
                    statusMessage.textContent = 'Copied to clipboard';
                    statusMessage.style.color = 'var(--success-color)';
                })
                .catch(err => {
                    console.error('Error copying text:', err);
                    statusMessage.textContent = 'Error copying to clipboard';
                    statusMessage.style.color = 'var(--error-color)';
                });
        }
        
        // Save transcript to file
        function saveTranscript() {
            const text = transcriptTextarea.value.trim();
            
            if (!text) {
                statusMessage.textContent = 'Nothing to save';
                statusMessage.style.color = 'var(--text-secondary)';
                return;
            }
            
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const lang = languageSelect.value.split('-')[0];
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `transcript_${lang}_${timestamp}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            statusMessage.textContent = 'Transcript saved';
            statusMessage.style.color = 'var(--success-color)';
        }
        
        // Update UI based on recording state
        function updateUI() {
            if (isRecording) {
                recordBtn.innerHTML = '<i class="fas fa-stop"></i> Stop Recording';
                recordBtn.classList.add('stop');
                statusIndicator.classList.add('recording');
                document.body.classList.add('recording');
            } else {
                recordBtn.innerHTML = '<i class="fas fa-microphone"></i> Start Recording';
                recordBtn.classList.remove('stop');
                statusIndicator.classList.remove('recording');
                document.body.classList.remove('recording');
            }
        }
        
        // Event listeners
        recordBtn.addEventListener('click', toggleRecording);
        clearBtn.addEventListener('click', clearTranscript);
        copyBtn.addEventListener('click', copyTranscript);
        saveBtn.addEventListener('click', saveTranscript);
        
        languageSelect.addEventListener('change', function() {
            if (recognition) {
                const wasRecording = isRecording;
                
                if (wasRecording) {
                    stopRecording();
                }
                
                recognition.lang = this.value;
                statusMessage.textContent = `Language changed to ${this.options[this.selectedIndex].text}`;
                statusMessage.style.color = 'var(--text-secondary)';
                
                if (wasRecording) {
                    // Small delay to ensure previous session is properly ended
                    setTimeout(startRecording, 200);
                }
            }
        });
        
        interimResultsCheckbox.addEventListener('change', function() {
            if (recognition) {
                recognition.interimResults = this.checked;
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Space to toggle recording
            if (e.code === 'Space' && document.activeElement !== transcriptTextarea) {
                e.preventDefault();
                toggleRecording();
            }
            
            // Ctrl+C to copy
            if (e.ctrlKey && e.code === 'KeyC' && document.activeElement !== transcriptTextarea) {
                e.preventDefault();
                copyTranscript();
            }
            
            // Ctrl+X to clear
            if (e.ctrlKey && e.code === 'KeyX' && document.activeElement !== transcriptTextarea) {
                e.preventDefault();
                clearTranscript();
            }
            
            // Ctrl+S to save
            if (e.ctrlKey && e.code === 'KeyS') {
                e.preventDefault();
                saveTranscript();
            }
        });
        
        // Adapt to parent theme
        function detectTheme() {
            try {
                // Try to get parent's theme
                const parentIsDark = window.parent.document.body.classList.contains('dark-theme');
                if (parentIsDark) {
                    document.body.classList.add('dark-theme');
                } else {
                    document.body.classList.remove('dark-theme');
                }
            } catch (e) {
                // If we can't access parent (e.g., due to iframe security),
                // use system preference
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                if (prefersDark) {
                    document.body.classList.add('dark-theme');
                }
            }
        }
        
        // Initialize everything
        function initialize() {
            initSpeechRecognition();
            detectTheme();
            setInterval(detectTheme, 1000); // Check theme periodically
        }
        
        // Run initialization on page load
        window.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>